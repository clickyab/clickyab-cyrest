---
# This is the staging build. it will build the app (using golang docker image) and run it with docker-compose
- name: staging build
  hosts: staging

  tasks:
    - name: make sure docker.py is ready
      pip:
        name: docker-py

    - name: pull the changes
      git:
        repo: git@github.com:clickyab/clickyab-cyrest.git
        dest: /home/cy/cyrest
        accept_hostkey: True

    - name: pull golang image
      docker_image:
        name: registry.clickyab.ae/clickyab/golang

    - name: pull mariadb image
      docker_image:
        name: registry.clickyab.ae/clickyab/mariadb

    - name: Re-create a redis container
      docker_container:
        name: golang-builder
        image: registry.clickyab.ae/clickyab/golang
        command: make server
        state: started
        recreate: True
        interactive: True
        volumes:
          - /home/cy/cyrest:/go

